<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>工作计划</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="css/common.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, sans-serif; background: #f8fafc; font-size: 15px; }
        .nav-module-link { color: rgba(255,255,255,0.9) !important; }
        .nav-module-link:hover, .nav-module-link.active { color: #fff !important; }
        .navbar { background: linear-gradient(135deg, #165DFF 0%, #0d3ba8 100%); padding: 0.5rem 1rem; }
        .navbar-brand { font-size: 16px; }
        @media (min-width: 992px) { .navbar-brand { font-size: 18px; } }

        /* 工作计划主区域 - 左侧日期 + 右侧表格 */
        .jihua-main {
            display: flex;
            gap: 0;
            align-items: stretch;
            background: #fff;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 24px rgba(2, 132, 199, 0.08);
            min-height: 420px;
        }
        .jihua-date-panel {
            width: 165px;
            min-width: 165px;
            background: linear-gradient(180deg, #f0f4f8 0%, #e8eef4 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 32px 18px;
            border-right: 1px solid #e2e8f0;
        }
        .jihua-date-panel .date-text {
            font-size: 14px;
            color: #1e5f74;
            font-weight: 600;
            text-align: center;
            margin-bottom: 16px;
            letter-spacing: 0.3px;
        }
        .jihua-date-panel .date-num {
            font-size: 72px;
            font-weight: 700;
            color: #1e5f74;
            line-height: 1;
            margin-bottom: 12px;
        }
        .jihua-date-panel .date-lunar {
            font-size: 13px;
            color: #64748b;
        }

        /* 表格 - 月份列加宽，新背景色 */
        .jihua-schedule {
            flex: 1;
            overflow: auto;
            background: #f7f9fc;
        }
        .jihua-schedule table { width: 100%; border-collapse: collapse; font-size: 15px; }
        .jihua-schedule th, .jihua-schedule td {
            padding: 15px 18px;
            text-align: center;
            border: 1px solid #e8ecf1;
        }
        .jihua-schedule thead th {
            background: linear-gradient(135deg, #1e5f74 0%, #2980b0 100%);
            color: #fff !important;
            font-weight: 600;
            font-size: 15px;
            letter-spacing: 0.5px;
        }
        .jihua-schedule .th-monthly { width: 155px; min-width: 155px; }
        .jihua-schedule .th-weekly { }
        .jihua-schedule tbody tr:nth-child(odd) .cell-month {
            background: linear-gradient(135deg, #a8d4e6 0%, #b8dce8 100%);
            color: #1e5f74;
        }
        .jihua-schedule tbody tr:nth-child(odd) .cell-week {
            background: #fff;
            color: #1e5f74;
        }
        .jihua-schedule tbody tr:nth-child(even) .cell-month {
            background: linear-gradient(135deg, #b8dce8 0%, #c8e4ee 100%);
            color: #1e5f74;
        }
        .jihua-schedule tbody tr:nth-child(even) .cell-week {
            background: #f0f4f8;
            color: #1e5f74;
        }
        .jihua-schedule .cell-month {
            font-weight: 600;
            font-size: 15px;
            text-align: center;
        }
        .jihua-schedule .cell-month .cell-month-link {
            color: #1e5f74;
            text-decoration: none;
            cursor: pointer;
        }
        .jihua-schedule .cell-month .cell-month-link:hover { text-decoration: underline; opacity: 0.9; }
        .jihua-schedule .cell-month .cell-month-text { color: #1e5f74; }
        .jihua-schedule .cell-week-link {
            color: #1e5f74;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
        }
        .jihua-schedule .cell-week-link:hover { color: #2980b0; text-decoration: underline; }

        .operation-btn { margin: 5px; }
        .btn-group-inline { display: inline-flex; gap: 5px; flex-wrap: wrap; }
        #operation-area { border-radius: 12px; border: 1px solid #e2e8f0; }

        .jihua-title-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 16px;
            background: linear-gradient(135deg, #ecf4f8 0%, #dde8f0 100%);
            padding: 18px 28px;
            margin-bottom: 0;
            border-radius: 16px 16px 0 0;
            border: 1px solid rgba(30, 95, 116, 0.2);
            border-bottom: none;
        }
        .jihua-title-bar h1 {
            font-size: 20px;
            font-weight: 700;
            color: #1e5f74;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 12px;
            letter-spacing: 0.5px;
        }
        .jihua-title-bar h1 i { color: #2980b0; }
        .jihua-title-bar .jihua-year-wrap {
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }
        .jihua-title-bar .jihua-year-wrap label { font-size: 14px; color: #475569; margin: 0; font-weight: 500; }
        .jihua-title-bar .jihua-year-wrap select {
            border-radius: 8px;
            border: 1px solid #b8c9d4;
            padding: 8px 14px;
            font-size: 14px;
            min-width: 100px;
            background: #fff;
        }
        .jihua-empty-tip {
            padding: 60px 24px;
            text-align: center;
            color: #94a3b8;
            font-size: 15px;
            background: #fff !important;
        }
        @media (max-width: 767px) {
            .jihua-main { flex-direction: column; }
            .jihua-date-panel { width: 100%; min-width: auto; flex-direction: row; flex-wrap: wrap; justify-content: center; gap: 16px; }
            .jihua-date-panel .date-num { font-size: 48px; margin: 0; }
            .jihua-schedule th, .jihua-schedule td { padding: 10px 8px; font-size: 13px; }
            .jihua-schedule .th-monthly { width: 120px; min-width: 120px; }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">市人大常委会监督协调处 <span class="navbar-version">V1.0</span></a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link nav-module-link" href="index.html">监督议题</a></li>
                    <li class="nav-item"><a class="nav-link nav-module-link" href="pishi.html">批示督办</a></li>
                    <li class="nav-item"><a class="nav-link nav-module-link" href="minsheng.html">民生实事</a></li>
                    <li class="nav-item"><a class="nav-link nav-module-link" href="meiyue.html">每月工作</a></li>
                    <li class="nav-item"><a class="nav-link nav-module-link" href="meizhou.html">每周工作</a></li>
                    <li class="nav-item"><a class="nav-link nav-module-link" href="falv.html">法律法规</a></li>
                    <li class="nav-item"><a class="nav-link nav-module-link active" href="jihua.html">计划月历</a></li>
                </ul>
                <div class="navbar-nav ms-auto">
                    <span class="nav-link text-white" id="user-role">当前身份：<b>游客（未登录）</b></span>
                    <button class="btn btn-outline-light ms-2" id="admin-mgmt-btn" style="display: none;"><i class="fa fa-users"></i> 管理员管理</button>
                    <button class="btn btn-outline-light ms-2" id="login-btn">管理员登录</button>
                    <button class="btn btn-outline-light ms-2" id="logout-btn" style="display: none;">退出登录</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4 mb-5 pb-4">
        <div class="card" id="operation-area" style="display: none;">
            <div class="card-header"><h5 class="mb-0">数据操作</h5></div>
            <div class="card-body">
                <div class="d-flex flex-wrap gap-2 align-items-center justify-content-end">
                    <button class="btn btn-primary" id="btn-upload"><i class="fa fa-upload"></i> 上传文件</button>
                    <div class="btn-group-inline">
                        <button class="btn btn-secondary operation-btn" id="backup-btn"><i class="fa fa-database"></i> 备份数据</button>
                        <button class="btn btn-dark operation-btn" id="restore-btn"><i class="fa fa-recycle"></i> 数据恢复</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="jihua-title-bar">
            <h1><i class="fa fa-calendar-check-o"></i>大连市人大常委会重点工作安排</h1>
            <div class="jihua-year-wrap">
                <label>年度</label>
                <select class="form-select form-select-sm" id="year-select"></select>
            </div>
        </div>

        <div class="jihua-main">
            <div class="jihua-date-panel">
                <div class="date-text" id="date-top"></div>
                <div class="date-num" id="date-day">20</div>
                <div class="date-lunar" id="date-lunar">农历</div>
            </div>
            <div class="jihua-schedule">
                <div id="jihua-grid-container"></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="upload-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">上传工作计划</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="upload-form">
                        <div class="mb-3">
                            <label class="form-label">类别 <span class="text-danger">*</span></label>
                            <select class="form-select" id="upload-category" required>
                                <option value="">请选择</option>
                                <option value="monthly">常委会每月</option>
                                <option value="weekly">各部门每周</option>
                            </select>
                        </div>
                        <div class="mb-3" id="upload-year-wrap">
                            <label class="form-label">年度 <span class="text-danger">*</span></label>
                            <select class="form-select" id="upload-year"></select>
                        </div>
                        <div class="mb-3" id="upload-month-wrap">
                            <label class="form-label">月份 <span class="text-danger">*</span></label>
                            <select class="form-select" id="upload-month"></select>
                        </div>
                        <div class="mb-3" id="upload-week-wrap" style="display: none;">
                            <label class="form-label">周数 <span class="text-danger">*</span></label>
                            <select class="form-select" id="upload-week"></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">选择文件 <span class="text-danger">*</span></label>
                            <input type="file" class="form-control" id="upload-file" accept=".pdf" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="btn-submit-upload"><i class="fa fa-upload"></i> 上传</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="restore-modal" tabindex="-1">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">数据恢复</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <p class="small text-muted">工作计划数据与每月工作、每周工作共用，请前往对应模块恢复。</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 工作计划预览弹窗 -->
    <div class="modal fade" id="jihua-preview-modal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-fullscreen-lg-down" style="max-width: 95%; height: 90vh;">
            <div class="modal-content h-100">
                <div class="modal-header py-2 d-flex align-items-center">
                    <h6 class="modal-title text-truncate flex-grow-1 pe-2" id="jihua-preview-title">预览</h6>
                    <span class="badge bg-primary bg-opacity-10 text-primary border border-primary me-2" style="font-size: 13px; padding: 5px 12px;"><i class="fa fa-hand-o-up me-1"></i>点击空白处关闭</span>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0" style="height: calc(100% - 50px);">
                    <iframe id="jihua-preview-iframe" style="width:100%;height:100%;border:none;" title="工作计划预览"></iframe>
                </div>
            </div>
        </div>
    </div>
    <script>
        document.getElementById('jihua-preview-modal').addEventListener('hidden.bs.modal', function () {
            document.getElementById('jihua-preview-iframe').src = 'about:blank';
        });
    </script>

    <div class="modal fade login-modal" id="login-modal" tabindex="-1">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">管理员登录</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="login-form">
                        <div class="mb-3"><label class="form-label">用户名</label><input type="text" class="form-control" id="login-username" required></div>
                        <div class="mb-3"><label class="form-label">密码</label><input type="password" class="form-control" id="login-password" required></div>
                        <div class="mb-3 form-check"><input type="checkbox" class="form-check-input" id="login-remember" checked><label class="form-check-label" for="login-remember">7日内免登录</label></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="login-submit">登录</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lunar-javascript/1.7.4/lunar.min.js"></script>
    <script>
        (function () {
            var token = null;
            function getToken() { return localStorage.getItem('token') || sessionStorage.getItem('token'); }
            function apiFetch(url, opts) {
                opts = opts || {};
                var h = opts.headers || {};
                if (getToken()) h['Authorization'] = 'Bearer ' + getToken();
                opts.headers = h;
                return fetch(url, opts);
            }
            function showToast(msg) {
                var el = document.getElementById('toast-notice');
                if (el) { el.textContent = msg; el.classList.add('show'); setTimeout(function () { el.classList.remove('show'); }, 2500); }
                else alert(msg);
            }

            var meiyueItems = [];
            var meizhouItems = [];
            var currentYear = new Date().getFullYear();

            function padMonth(m) { var s = String(m); return s.length === 1 ? '0' + s : s; }

            function loadMeiyue() {
                return apiFetch('/api/meiyue').then(function (r) { return r.json(); }).then(function (res) {
                    meiyueItems = (res.data || []).filter(function (p) { return p.filePath; });
                    return meiyueItems;
                }).catch(function () { meiyueItems = []; return []; });
            }
            function loadMeizhou() {
                return apiFetch('/api/meizhou').then(function (r) { return r.json(); }).then(function (res) {
                    meizhouItems = res.data || [];
                    return meizhouItems;
                }).catch(function () { meizhouItems = []; return []; });
            }

            function findMeiyue(year, month) {
                var y = String(year); var mo = parseInt(month, 10);
                return meiyueItems.find(function (p) {
                    var py = String(p.year || ''); var pm = parseInt(p.month || '0', 10);
                    return py === y && pm === mo;
                });
            }
            function findMeizhou(year, month, week) {
                var y = String(year); var m = parseInt(month, 10); var w = String(week);
                return meizhouItems.find(function (p) {
                    var py = String(p.year || ''); var pm = parseInt(p.month || '0', 10); var pw = String(p.week || '');
                    return py === y && pm === m && pw === w;
                });
            }

            function getWeeksInMonth(year, month) {
                var d = new Date(year, month - 1, 1);
                var last = new Date(year, month, 0);
                var weeks = [];
                var w = 1;
                while (d <= last) {
                    var dayOfWeek = d.getDay();
                    var start = new Date(d);
                    var end = new Date(d);
                    var days = 0;
                    while (days < 7 && d <= last) { days++; d.setDate(d.getDate() + 1); }
                    end.setTime(d.getTime() - 1);
                    weeks.push({ week: w, start: start, end: end });
                    w++;
                }
                return weeks;
            }

            function renderDateSection() {
                var now = new Date();
                var weekdays = ['星期日','星期一','星期二','星期三','星期四','星期五','星期六'];
                document.getElementById('date-top').textContent = now.getFullYear() + '年' + (now.getMonth() + 1) + '月' + now.getDate() + '日 ' + weekdays[now.getDay()];
                document.getElementById('date-day').textContent = now.getDate();
                var lunarStr = '农历';
                try {
                    if (typeof Lunar !== 'undefined') {
                        var lunar = Lunar.fromDate(now);
                        var sx = lunar.getYearShengXiao ? lunar.getYearShengXiao() : (lunar.getYearInGanZhi ? lunar.getYearInGanZhi() : '');
                        var md = (lunar.getMonthInChinese ? lunar.getMonthInChinese() : '') + (lunar.getDayInChinese ? lunar.getDayInChinese() : '');
                        lunarStr = (sx ? '【' + sx + '】' : '') + '农历' + (md || '');
                    }
                } catch (e) {}
                document.getElementById('date-lunar').textContent = lunarStr;
            }

            function renderYearSelect() {
                var sel = document.getElementById('year-select');
                var start = currentYear - 1;
                var end = currentYear + 1;
                sel.innerHTML = '';
                for (var y = end; y >= start; y--) {
                    var opt = document.createElement('option');
                    opt.value = y;
                    opt.textContent = y + '年';
                    if (y === currentYear) opt.selected = true;
                    sel.appendChild(opt);
                }
                sel.addEventListener('change', function () {
                    currentYear = parseInt(sel.value, 10);
                    renderGrid();
                });
            }

            function monthHasContent(m) {
                if (findMeiyue(currentYear, m)) return true;
                var weeks = getWeeksInMonth(currentYear, m);
                for (var i = 0; i < weeks.length; i++) {
                    if (findMeizhou(currentYear, m, weeks[i].week)) return true;
                }
                return false;
            }

            function renderGrid() {
                var container = document.getElementById('jihua-grid-container');
                var html = '<table><thead><tr>';
                html += '<th class="th-monthly">常委会每月重点工作安排</th>';
                html += '<th colspan="5" class="th-weekly">机关各部门每周重点工作安排</th>';
                html += '</tr></thead><tbody>';
                var hasAny = false;
                for (var m = 12; m >= 1; m--) {
                    if (!monthHasContent(m)) continue;
                    hasAny = true;
                    var meiyue = findMeiyue(currentYear, m);
                    var hasMonthFile = !!meiyue;
                    html += '<tr>';
                    html += '<td class="cell-month">';
                    if (hasMonthFile) {
                        html += '<a class="cell-month-link" href="javascript:void(0)" data-type="month" data-id="' + meiyue.id + '" data-month="' + m + '" title="点击预览">' + m + '月</a>';
                    } else {
                        html += '<span class="cell-month-text">' + m + '月</span>';
                    }
                    html += '</td>';
                    var weeks = getWeeksInMonth(currentYear, m);
                    for (var wi = 0; wi < 5; wi++) {
                        var w = wi < weeks.length ? weeks[wi].week : 0;
                        var meizhou = w ? findMeizhou(currentYear, m, w) : null;
                        var hasWeekFile = !!meizhou;
                        html += '<td class="cell-week">';
                        if (w && hasWeekFile) {
                            html += '<a class="cell-week-link" href="javascript:void(0)" data-year="' + currentYear + '" data-month="' + m + '" data-week="' + w + '" data-type="week" data-id="' + meizhou.id + '" title="点击预览">第' + w + '周</a>';
                        } else if (w) {
                            html += '';
                        } else {
                            html += '-';
                        }
                        html += '</td>';
                    }
                    html += '</tr>';
                }
                if (!hasAny) html += '<tr><td colspan="6" class="jihua-empty-tip">当前年度暂无工作计划数据</td></tr>';
                html += '</tbody></table>';
                container.innerHTML = html;

                container.querySelectorAll('.cell-month-link[data-type="month"]').forEach(function (el) {
                    el.addEventListener('click', function (e) {
                        e.preventDefault();
                        var id = el.dataset.id;
                        if (!id) return;
                        document.getElementById('jihua-preview-title').textContent = currentYear + '年' + el.dataset.month + '月 常委会重点工作';
                        document.getElementById('jihua-preview-iframe').src = 'meiyue-detail.html?id=' + id + '&embed=1';
                        new bootstrap.Modal(document.getElementById('jihua-preview-modal')).show();
                    });
                });

                container.querySelectorAll('.cell-week-link[data-type="week"]').forEach(function (el) {
                    el.addEventListener('click', function (e) {
                        e.preventDefault();
                        var id = el.dataset.id;
                        if (!id) return;
                        document.getElementById('jihua-preview-title').textContent = currentYear + '年' + el.dataset.month + '月第' + el.dataset.week + '周 机关各部门重点工作';
                        document.getElementById('jihua-preview-iframe').src = 'meizhou-detail.html?id=' + id + '&embed=1';
                        new bootstrap.Modal(document.getElementById('jihua-preview-modal')).show();
                    });
                });
            }

            function initUploadModal() {
                var cat = document.getElementById('upload-category');
                var yearWrap = document.getElementById('upload-year-wrap');
                var yearSel = document.getElementById('upload-year');
                var monthWrap = document.getElementById('upload-month-wrap');
                var weekWrap = document.getElementById('upload-week-wrap');
                var monthSel = document.getElementById('upload-month');
                var weekSel = document.getElementById('upload-week');
                var y0 = new Date().getFullYear();
                for (var y = y0 - 1; y <= y0 + 2; y++) {
                    var o = document.createElement('option');
                    o.value = y;
                    o.textContent = y + '年';
                    yearSel.appendChild(o);
                }
                for (var m = 1; m <= 12; m++) {
                    var o = document.createElement('option');
                    o.value = m;
                    o.textContent = m + '月';
                    monthSel.appendChild(o);
                }
                for (var w = 1; w <= 5; w++) {
                    var o = document.createElement('option');
                    o.value = w;
                    o.textContent = '第' + w + '周';
                    weekSel.appendChild(o);
                }
                cat.addEventListener('change', function () {
                    var v = cat.value;
                    monthWrap.style.display = (v === 'monthly' || v === 'weekly') ? 'block' : 'none';
                    weekWrap.style.display = v === 'weekly' ? 'block' : 'none';
                });
            }

            document.getElementById('btn-upload').addEventListener('click', function () {
                document.getElementById('upload-form').reset();
                document.getElementById('upload-year').value = currentYear;
                document.getElementById('upload-category').dispatchEvent(new Event('change'));
                new bootstrap.Modal(document.getElementById('upload-modal')).show();
            });

            document.getElementById('btn-submit-upload').addEventListener('click', function () {
                var cat = document.getElementById('upload-category').value;
                var year = document.getElementById('upload-year').value;
                var month = document.getElementById('upload-month').value;
                var week = document.getElementById('upload-week').value;
                var fileInput = document.getElementById('upload-file');
                if (!fileInput.files || !fileInput.files[0]) { showToast('请选择文件'); return; }
                if (!year) { showToast('请选择年度'); return; }
                var fd = new FormData();
                fd.append('year', year);
                fd.append('month', padMonth(month));
                fd.append('file', fileInput.files[0]);

                if (cat === 'monthly') {
                    var existing = findMeiyue(year, month);
                    if (existing) {
                        apiFetch('/api/meiyue/' + existing.id + '/replace-file', {
                            method: 'POST',
                            body: fd
                        }).then(function (r) { return r.json(); }).then(function (res) {
                            if (res.code === 0) { showToast('已替换'); bootstrap.Modal.getInstance(document.getElementById('upload-modal')).hide(); loadMeiyue().then(renderGrid); }
                            else showToast(res.msg || '替换失败');
                        }).catch(function () { showToast('操作失败'); });
                    } else {
                        apiFetch('/api/meiyue/upload', { method: 'POST', body: fd }).then(function (r) { return r.json(); }).then(function (res) {
                            if (res.code === 0) { showToast('上传成功'); bootstrap.Modal.getInstance(document.getElementById('upload-modal')).hide(); loadMeiyue().then(renderGrid); }
                            else showToast(res.msg || '上传失败');
                        }).catch(function () { showToast('上传失败'); });
                    }
                } else if (cat === 'weekly') {
                    fd.append('week', week);
                    var existing = findMeizhou(year, month, week);
                    if (existing) {
                        apiFetch('/api/meizhou/' + existing.id + '/replace-file', {
                            method: 'POST',
                            body: fd
                        }).then(function (r) { return r.json(); }).then(function (res) {
                            if (res.code === 0) { showToast('已替换'); bootstrap.Modal.getInstance(document.getElementById('upload-modal')).hide(); loadMeizhou().then(renderGrid); }
                            else showToast(res.msg || '替换失败');
                        }).catch(function () { showToast('操作失败'); });
                    } else {
                        apiFetch('/api/meizhou/upload', { method: 'POST', body: fd }).then(function (r) { return r.json(); }).then(function (res) {
                            if (res.code === 0) { showToast('上传成功'); bootstrap.Modal.getInstance(document.getElementById('upload-modal')).hide(); loadMeizhou().then(renderGrid); }
                            else showToast(res.msg || '上传失败');
                        }).catch(function () { showToast('上传失败'); });
                    }
                } else {
                    showToast('请选择类别');
                }
            });

            document.getElementById('backup-btn').addEventListener('click', function () {
                showToast('工作计划数据与每月工作、每周工作共用，请前往对应模块备份');
            });
            document.getElementById('restore-btn').addEventListener('click', function () {
                new bootstrap.Modal(document.getElementById('restore-modal')).show();
            });

            document.getElementById('login-btn').addEventListener('click', function () { new bootstrap.Modal(document.getElementById('login-modal')).show(); });
            document.getElementById('login-submit').addEventListener('click', function () {
                var u = document.getElementById('login-username').value.trim();
                var p = document.getElementById('login-password').value.trim();
                var rem = document.getElementById('login-remember').checked;
                if (!u || !p) { showToast('请输入用户名和密码'); return; }
                fetch('/api/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: u, password: p, rememberMe: rem }) })
                    .then(function (r) { return r.json(); })
                    .then(function (res) {
                        if (res.code === 0) {
                            if (rem) localStorage.setItem('token', res.data.token);
                            else sessionStorage.setItem('token', res.data.token);
                            bootstrap.Modal.getInstance(document.getElementById('login-modal')).hide();
                            location.reload();
                        } else showToast(res.msg);
                    }).catch(function () { showToast('登录失败'); });
            });
            document.getElementById('logout-btn').addEventListener('click', function () {
                var t = getToken();
                if (t) fetch('/api/logout', { method: 'POST', headers: { 'Authorization': 'Bearer ' + t } }).catch(function () {});
                localStorage.removeItem('token');
                sessionStorage.removeItem('token');
                document.getElementById('user-role').innerHTML = '当前身份：<b>游客（未登录）</b>';
                document.getElementById('login-btn').style.display = '';
                document.getElementById('logout-btn').style.display = 'none';
                document.getElementById('operation-area').style.display = 'none';
                showToast('已退出登录');
            });

            function initAuth() {
                var t = getToken();
                if (!t) {
                    document.getElementById('user-role').innerHTML = '当前身份：<b>游客（未登录）</b>';
                    document.getElementById('login-btn').style.display = '';
                    document.getElementById('logout-btn').style.display = 'none';
                    document.getElementById('operation-area').style.display = 'none';
                    return;
                }
                apiFetch('/api/me').then(function (r) { return r.json(); }).then(function (res) {
                    if (res.code === 0) {
                        document.getElementById('user-role').innerHTML = '当前身份：<b>' + (res.data.role === 'super_admin' ? '超级管理员' : '管理员') + '（' + res.data.username + '）</b>';
                        document.getElementById('login-btn').style.display = 'none';
                        document.getElementById('logout-btn').style.display = '';
                        document.getElementById('operation-area').style.display = '';
                    }
                }).catch(function () {});
            }

            initUploadModal();
            renderDateSection();
            renderYearSelect();
            Promise.all([loadMeiyue(), loadMeizhou()]).then(function () {
                renderGrid();
            });
            initAuth();
        })();
    </script>
    <div class="toast-notice" id="toast-notice" style="position:fixed;top:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.8);color:#fff;padding:12px 20px;border-radius:4px;z-index:9999;opacity:0;transition:opacity 0.3s;"></div>
</body>
</html>
